"0","# Observed accuracy"
"0","observed_acc <- mean(pred_classes_test == y_test)"
"0",""
"0","# Permutation loop"
"0","n_perms <- 1000"
"0","perm_accs <- numeric(n_perms)"
"0",""
"0","for (i in 1:n_perms) {"
"0","  permuted_labels <- sample(y_test)"
"0","  dtest_perm <- xgb.DMatrix(data = x_test, label = permuted_labels)"
"0","  "
"0","  pred_probs_perm <- predict(final_model, dtest_perm, reshape = TRUE)"
"0","  colnames(pred_probs_perm) <- as.character(class_labels)"
"0",""
"0","  thresholded_preds_perm <- sapply(class_labels, function(cls) {"
"0","    probs <- pred_probs_perm[, as.character(cls)]"
"0","    as.integer(probs >= best_thresholds[as.character(cls)])"
"0","  })"
"0",""
"0","  pred_classes_perm <- apply(thresholded_preds_perm, 1, function(row) {"
"0","    if (sum(row) == 0) return(NA)"
"0","    else if (sum(row) == 1) return(which(row == 1) - 1)"
"0","    else return(which.max(pred_probs_perm[row == 1, ][1, ]) - 1)"
"0","  })"
"0",""
"0","  na_idx <- is.na(pred_classes_perm)"
"0","  if (any(na_idx)) {"
"0","    fallback_preds <- max.col(pred_probs_perm[na_idx, ]) - 1"
"0","    pred_classes_perm[na_idx] <- fallback_preds"
"0","  }"
"0",""
"0","  perm_accs[i] <- mean(pred_classes_perm == permuted_labels)"
"0","}"
"0",""
"0","# Compute p-value"
"0","p_value <- mean(perm_accs >= observed_acc)"
"0","print(paste(""Permutation test p-value:"", p_value))"
"1","[1]"
"1"," ""Permutation test p-value: 0.953"""
"1","
"
